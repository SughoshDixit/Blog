---
Id: 1029
Title: "Day 29: Putting It All Together - Constructing a Stratified Audit Plan"
Author: Sughosh P Dixit
Date: "2025-11-29"
Tags: Data Science Stratified Sampling Audit Plan Sample Size Power Analysis Risk Stratification
Topic: Data Science
Abstract: "Synthesize everything from quantile thresholds to strata to sample sizes. Learn to construct a complete stratified audit plan with cutoffs, sample sizes, and investigation workflows."
HeaderImage: /DS-29/audit_plan_intro.png
isPublished: true
---

# **Day 29: Putting It All Together - Constructing a Stratified Audit Plan** ğŸ“‹ğŸ¯

<p style={{fontStyle: 'italic', color: '#666', marginTop: '1rem', textAlign: 'center'}}>Synthesize quantile thresholds, stratification, sample sizes, and investigation workflows into a complete audit plan.</p>

<Lottie animation="analyticsPulse" height={240} width={340} caption="A stratified audit plan brings together all the mathematical concepts we've learned into a practical, actionable framework." />

<p style={{fontStyle: 'italic', color: '#666', margin: '1rem 0 2rem', textAlign: 'center'}}>We've built the mathematical foundations. Now it's time to assemble them into a complete stratified audit planâ€”from threshold computation to sample selection to investigation summary.</p>

> ğŸ’¡ **Note:** This article uses technical terms and abbreviations. For definitions, check out the [Key Terms & Glossary](/key) page.

---

## The Goal: End-to-End Audit Plan ğŸ¯

**Objective:** Design a stratified sampling plan that:
1. Partitions population into meaningful strata
2. Allocates samples optimally across strata
3. Enables statistical inference about fraud rates
4. Provides actionable investigation priorities

**Key Components:**
```
Threshold Computation â†’ Stratification â†’ Sample Sizing â†’ 
Selection â†’ Investigation â†’ Summary â†’ Adjustment
```

---

## Step 1: Threshold Computation ğŸ“Š

### Using Quantile-Based Cutoffs

**Approach:** Use percentiles to define stratum boundaries.

**Example: Transaction Amount Strata**

```python
# Compute percentile cutoffs
data = transactions['amount']
cutoffs = {
    'Low': (0, np.percentile(data, 50)),           # 0-50th percentile
    'Medium': (np.percentile(data, 50), np.percentile(data, 85)),  # 50-85th
    'High': (np.percentile(data, 85), np.percentile(data, 99)),    # 85-99th
    'Extreme': (np.percentile(data, 99), np.inf)   # 99th+
}
```

**Result:**
```
Stratum     Range           Count    % of Population
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Low         $0 - $100       50,000   50%
Medium      $100 - $500     35,000   35%
High        $500 - $2,000   14,000   14%
Extreme     $2,000+          1,000    1%
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total                      100,000  100%
```

**Visual Example:**

<img src="/DS-29/threshold_cutoffs.png" alt="Threshold Cutoffs" style={{maxWidth: '100%', height: 'auto', display: 'block', margin: '1.5rem auto', borderRadius: '8px'}} />

<Lottie animation="robustWorkflow" height={220} width={320} caption="Percentile-based cutoffs create strata that reflect the natural distribution of your data." />

---

## Step 2: Stratification Design ğŸ“

### Combining Multiple Features

**Multi-dimensional stratification:**

```python
def create_strata(df):
    """
    Create strata based on multiple features.
    """
    strata = []
    
    for amount_level in ['Low', 'Medium', 'High', 'Extreme']:
        for risk_level in ['Low', 'Medium', 'High']:
            for account_age in ['New', 'Seasoned']:
                stratum = f"{amount_level}_{risk_level}_{account_age}"
                strata.append(stratum)
    
    return strata  # 4 Ã— 3 Ã— 2 = 24 strata
```

### Stratum Characteristics

**For each stratum, compute:**
1. **Population size (N_h):** Number of elements
2. **Expected fraud rate (p_h):** Historical or estimated
3. **Variance (ÏƒÂ²_h):** Variability within stratum
4. **Cost per sample (c_h):** Investigation cost

**Example Table:**

```
Stratum              N_h     p_h     ÏƒÂ²_h    Priority
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Extreme_High_New     200     0.15    0.13    ğŸ”´ Critical
Extreme_High_Seas    150     0.08    0.07    ğŸŸ¡ High
High_High_New        500     0.12    0.11    ğŸ”´ Critical
High_Medium_New      800     0.06    0.06    ğŸŸ¡ High
Medium_Low_Seas    10000     0.01    0.01    ğŸŸ¢ Routine
Low_Low_Seas       35000     0.002   0.002   ğŸŸ¢ Routine
```

**Visual Example:**

<img src="/DS-29/stratification_design.png" alt="Stratification Design" style={{maxWidth: '100%', height: 'auto', display: 'block', margin: '1.5rem auto', borderRadius: '8px'}} />

---

## Step 3: Sample Size Determination ğŸ”¢

### Power Analysis Framework

**Goal:** Determine sample size n_h for each stratum to detect fraud rate p_h with desired power.

**Using Day 14 concepts:**

```python
def required_sample_size(p_h, p_0, alpha=0.05, power=0.80):
    """
    Sample size for detecting deviation from baseline.
    
    p_h: Expected fraud rate in stratum
    p_0: Null hypothesis rate
    alpha: Significance level
    power: Desired power (1 - Î²)
    """
    from scipy import stats
    
    z_alpha = stats.norm.ppf(1 - alpha/2)
    z_beta = stats.norm.ppf(power)
    
    effect = p_h - p_0
    pooled_var = p_h * (1 - p_h) + p_0 * (1 - p_0)
    
    n = ((z_alpha + z_beta)**2 * pooled_var) / (effect**2)
    
    return int(np.ceil(n))
```

### Allocation Strategies

**Proportional Allocation:**
```
n_h = n Ã— (N_h / N)
```

**Neyman Allocation (optimal for variance):**
```
n_h = n Ã— (N_h Ã— Ïƒ_h) / Î£(N_j Ã— Ïƒ_j)
```

**Risk-Weighted Allocation:**
```
n_h = n Ã— (N_h Ã— p_h) / Î£(N_j Ã— p_j)
```

### Sample Size Table

```
Stratum              N_h     p_h     Proportional  Neyman    Risk-Weighted
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Extreme_High_New     200     0.15         2          15          50
Extreme_High_Seas    150     0.08         2          10          20
High_High_New        500     0.12         5          35          100
High_Medium_New      800     0.06         8          30          80
Medium_Low_Seas    10000     0.01        100         50          167
Low_Low_Seas       35000     0.002       350         20          117
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total Sample         n       -          467         160         534
```

**Visual Example:**

<img src="/DS-29/sample_allocation.png" alt="Sample Allocation" style={{maxWidth: '100%', height: 'auto', display: 'block', margin: '1.5rem auto', borderRadius: '8px'}} />

<Lottie animation="breakdownFortress" height={220} width={320} caption="Different allocation strategies prioritize different objectivesâ€”choose based on your audit goals." />

---

## Step 4: Sample Selection ğŸ²

### Random Selection Within Strata

```python
def select_stratified_sample(df, strata_col, sample_sizes):
    """
    Select random samples from each stratum.
    """
    samples = []
    
    for stratum, n in sample_sizes.items():
        stratum_data = df[df[strata_col] == stratum]
        
        if len(stratum_data) <= n:
            # Take all if stratum is small
            sample = stratum_data
        else:
            # Random sample
            sample = stratum_data.sample(n=n, random_state=42)
        
        samples.append(sample)
    
    return pd.concat(samples)
```

### Selection Tracking

```python
selection_log = {
    'stratum': [],
    'population_size': [],
    'sample_size': [],
    'sampling_fraction': [],
    'selection_date': [],
}
```

---

## Step 5: Investigation Workflow ğŸ”

### Investigation Priority Queue

```python
def prioritize_investigations(sample, priority_rules):
    """
    Assign investigation priority based on rules.
    """
    priorities = []
    
    for idx, row in sample.iterrows():
        # Apply priority rules
        if row['stratum'].startswith('Extreme_High'):
            priority = 1  # Immediate
        elif row['stratum'].startswith('High_High'):
            priority = 2  # Urgent
        elif 'High' in row['stratum']:
            priority = 3  # Standard
        else:
            priority = 4  # Routine
        
        priorities.append(priority)
    
    sample['priority'] = priorities
    return sample.sort_values('priority')
```

### Investigation Outcomes

**Track for each case:**
- Confirmed Fraud (True Positive)
- Legitimate (False Positive)
- Inconclusive
- Time to resolution

---

## Step 6: Summary and Reporting ğŸ“‹

### Stratum-Level Summary

```python
def investigation_summary(results):
    """
    Summarize investigation results by stratum.
    """
    summary = results.groupby('stratum').agg({
        'is_fraud': ['sum', 'count', 'mean'],
        'amount': 'sum',
        'resolution_hours': 'mean'
    })
    
    summary.columns = ['fraud_count', 'total_reviewed', 
                       'fraud_rate', 'total_amount', 'avg_hours']
    
    return summary
```

### Example Summary Report

```
Stratum              Reviewed  Fraud  Rate    Amount      Avg Hours
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Extreme_High_New        50       8    16.0%   $125,000      2.5
Extreme_High_Seas       20       2    10.0%    $45,000      2.0
High_High_New          100      10    10.0%   $280,000      3.0
High_Medium_New         80       4     5.0%   $150,000      2.5
Medium_Low_Seas        167       2     1.2%   $200,000      1.5
Low_Low_Seas           117       0     0.0%    $80,000      1.0
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TOTAL                  534      26     4.9%   $880,000      2.1
```

**Visual Example:**

<img src="/DS-29/summary_report.png" alt="Summary Report" style={{maxWidth: '100%', height: 'auto', display: 'block', margin: '1.5rem auto', borderRadius: '8px'}} />

---

## Step 7: Overlay Adjustments ğŸ”§

### Using Results to Refine Thresholds

**Based on investigation findings:**

1. **Adjust cutoffs** if fraud rates differ from expected
2. **Reallocate samples** to high-yield strata
3. **Update priority rules** based on actual outcomes
4. **Refine feature selection** for stratification

### Adjustment Framework

```python
def suggest_adjustments(summary, expectations):
    """
    Suggest threshold adjustments based on results.
    """
    adjustments = []
    
    for stratum, row in summary.iterrows():
        expected = expectations.get(stratum, {}).get('fraud_rate', 0.05)
        actual = row['fraud_rate']
        
        if actual > expected * 1.5:
            adjustments.append({
                'stratum': stratum,
                'action': 'LOWER_THRESHOLD',
                'reason': f'Fraud rate {actual:.1%} >> expected {expected:.1%}'
            })
        elif actual < expected * 0.5:
            adjustments.append({
                'stratum': stratum,
                'action': 'RAISE_THRESHOLD',
                'reason': f'Fraud rate {actual:.1%} << expected {expected:.1%}'
            })
    
    return adjustments
```

**Visual Example:**

<img src="/DS-29/overlay_adjustments.png" alt="Overlay Adjustments" style={{maxWidth: '100%', height: 'auto', display: 'block', margin: '1.5rem auto', borderRadius: '8px'}} />

<Lottie animation="classicalVsRobust" height={220} width={320} caption="The audit cycle closes with adjustments that feed back into improved stratification and sampling for the next round." />

---

## Exercise: Design a Three-Strata Plan ğŸ“

### The Problem

**Given:** A mock feature "transaction_velocity" (transactions per hour)

**Design:** A three-strata audit plan with:
1. Cutoffs (percentile-based)
2. Sample sizes (power-based)
3. Expected outcomes

### Solution

**Step 1: Analyze Feature Distribution**

```python
velocity_data = [0.5, 1, 2, 3, 5, 8, 10, 15, 20, 50, ...]  # n = 10,000
```

**Compute percentiles:**
```
p50 = 5 transactions/hour
p85 = 15 transactions/hour
p99 = 50 transactions/hour
```

**Step 2: Define Strata**

| Stratum | Range | N_h | Expected p_h |
|---------|-------|-----|--------------|
| Low | 0 - 5 | 5,000 | 0.5% |
| Medium | 5 - 15 | 3,500 | 2% |
| High | 15+ | 1,500 | 8% |

**Step 3: Compute Sample Sizes**

Using power = 80%, Î± = 0.05, detecting p_h vs p_0 = 0.5%:

```
Low:    n = 100 (confirm low rate)
Medium: n = 150 (detect elevation)
High:   n = 200 (estimate accurately)
Total:  n = 450
```

**Step 4: Expected Outcomes**

```
Stratum    Sample    Expected Fraud    Expected Rate
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Low        100       0-1               ~0.5%
Medium     150       2-4               ~2%
High       200       14-18             ~8%
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total      450       16-23             ~4%
```

**Step 5: Document the Plan**

```python
audit_plan = {
    'feature': 'transaction_velocity',
    'strata': [
        {'name': 'Low', 'range': (0, 5), 'n': 100, 'priority': 3},
        {'name': 'Medium', 'range': (5, 15), 'n': 150, 'priority': 2},
        {'name': 'High', 'range': (15, np.inf), 'n': 200, 'priority': 1}
    ],
    'total_sample': 450,
    'power': 0.80,
    'alpha': 0.05,
    'version': '1.0',
    'created': '2025-11-29'
}
```

**Visual Example:**

<img src="/DS-29/exercise_plan.png" alt="Exercise Plan" style={{maxWidth: '100%', height: 'auto', display: 'block', margin: '1.5rem auto', borderRadius: '8px'}} />

---

## Complete Workflow Flowchart ğŸ“Š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Raw Data           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Compute Quantiles  â”‚â—„â”€â”€ Day 13-15: Percentiles, ECDF
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Define Strata      â”‚â—„â”€â”€ Day 23-24: Partitioning, Risk Levels
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Compute Sample     â”‚â—„â”€â”€ Day 14: Power Analysis
â”‚  Sizes              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Select Samples     â”‚â—„â”€â”€ Day 16: Hypergeometric Sampling
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Investigate        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Summarize Results  â”‚â—„â”€â”€ Day 18: F1 Score, Metrics
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Adjust Thresholds  â”‚â—„â”€â”€ Day 22: Set Overlap Analysis
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  Loop back to refine
```

**Visual Example:**

<img src="/DS-29/complete_flowchart.png" alt="Complete Flowchart" style={{maxWidth: '100%', height: 'auto', display: 'block', margin: '1.5rem auto', borderRadius: '8px'}} />

---

## Summary Table ğŸ“‹

<table>
<thead>
<tr>
<th>Step</th>
<th>Input</th>
<th>Output</th>
<th>Key Concepts</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>1. Thresholds</strong></td>
<td>Raw data</td>
<td>Percentile cutoffs</td>
<td>Quantiles, ECDF</td>
</tr>
<tr>
<td><strong>2. Stratification</strong></td>
<td>Cutoffs</td>
<td>Strata definitions</td>
<td>Partitioning</td>
</tr>
<tr>
<td><strong>3. Sample Sizing</strong></td>
<td>Strata, power</td>
<td>n per stratum</td>
<td>Power analysis</td>
</tr>
<tr>
<td><strong>4. Selection</strong></td>
<td>Population</td>
<td>Sample</td>
<td>Random sampling</td>
</tr>
<tr>
<td><strong>5. Investigation</strong></td>
<td>Sample</td>
<td>Outcomes</td>
<td>Priority queue</td>
</tr>
<tr>
<td><strong>6. Summary</strong></td>
<td>Outcomes</td>
<td>Report</td>
<td>Rates, metrics</td>
</tr>
<tr>
<td><strong>7. Adjustment</strong></td>
<td>Report</td>
<td>New thresholds</td>
<td>Feedback loop</td>
</tr>
</tbody>
</table>

---

## Final Thoughts ğŸŒŸ

A stratified audit plan is the culmination of all our mathematical tools:

- **Quantiles** define stratum boundaries
- **Power analysis** determines sample sizes
- **Stratification** enables targeted investigation
- **Metrics** measure effectiveness
- **Feedback loops** enable continuous improvement

**Key Takeaways:**

âœ… **Quantile thresholds** create meaningful strata
âœ… **Sample allocation** balances precision and cost
âœ… **Power analysis** ensures detectable differences
âœ… **Investigation priority** focuses resources
âœ… **Summary reporting** enables decisions
âœ… **Overlay adjustments** close the loop

**Plan stratified, investigate smart!** ğŸ“‹ğŸ¯

**Tomorrow's Preview:** Day 30 - A Mathematical Blueprint for Scenario Calibration ğŸ—ºï¸ğŸ“

---


